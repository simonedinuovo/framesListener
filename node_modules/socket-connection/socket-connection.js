var execSync = require('child_process').execSync;
var exec = require('child_process').exec;

try{
    var ws = require('ws');
}
catch(e){
    console.log("installing ws dep...");
    var install_ws = execSync('npm install ws --save-dev');
    console.log("done");
    var ws = require('ws');
}

var WebSocketServer = require('ws').Server
    , wss = new WebSocketServer({ port: 8080 });

wss.on('connection', function connection(ws) {
    ws.on('open', function() {
        console.log('connected');
        ws.send(Date.now().toString());
    });

    ws.on('close', function() {
        console.log('disconnected');
    });

    ws.on('message', function(data, flags) {
        console.log('Roundtrip time: ' + (Date.now() - Number(data)) + 'ms', flags);
        ws.send(Date.now().toString());
    });
});